@page "/edit-resource/{id:guid}"
@using LearningResourcesApp.Client.Models.Leermiddelen
@using LearningResourcesApp.Client.Services
@using LearningResourcesApp.Client.Components.Base
@inherits BaseComponentWithErrorHandling
@inject ILeermiddelService LeermiddelService
@inject NavigationManager Navigatie

<PageTitle>Leermiddel Bewerken</PageTitle>

<div class="container mt-4">
    <ErrorAlert Message="@foutmelding" OnDismiss="ClearError" />

    @if (leermiddel == null && !heeftFout)
    {
        <div class="alert alert-warning">
            Leermiddel aan het laden...
        </div>
    }
    else if (heeftFout)
    {
        <div class="alert alert-danger">
            Leermiddel niet gevonden of er is een fout opgetreden.
        </div>
        <button class="btn btn-secondary" @onclick="@(() => Navigatie.NavigateTo("/"))">Terug naar Lijst</button>
    }
    else
    {
        <h3>Leermiddel Bewerken</h3>

        <LeermiddelForm Leermiddel="@leermiddel"
                        SubmitButtonText="Wijzigingen Opslaan"
                        OnValidSubmit="@VerwerkWijziging"
                        OnCancelled="@Annuleren" />
    }
</div>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Leermiddel? leermiddel;
    private bool heeftFout = false;

    protected override async Task OnInitializedAsync()
    {
        await ExecuteAsync(async () =>
        {
            leermiddel = await LeermiddelService.HaalLeermiddelOpMetId(Id);

            if (leermiddel == null)
            {
                heeftFout = true;
            }
        }, "Er is een fout opgetreden bij het laden van het leermiddel");

        if (!string.IsNullOrEmpty(foutmelding))
        {
            heeftFout = true;
        }
    }

    private async Task VerwerkWijziging(Leermiddel gewijzigdLeermiddel)
    {
        await ExecuteAsync(async () =>
        {
            if (!string.IsNullOrWhiteSpace(gewijzigdLeermiddel.Titel))
            {
                var succes = await LeermiddelService.WijzigLeermiddel(gewijzigdLeermiddel);
                if (succes)
                {
                    Navigatie.NavigateTo($"/resource/{Id}");
                }
                else
                {
                    foutmelding = "Het wijzigen van het leermiddel is mislukt.";
                }
            }
        }, "Er is een fout opgetreden bij het wijzigen van het leermiddel");
    }

    private void Annuleren()
    {
        Navigatie.NavigateTo($"/resource/{Id}");
    }
}
